<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Learn Mate - Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/heroicons@2.0.18/outline.css" rel="stylesheet">
    <link th:href="@{/css/main.css}" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md">
        <h1 class="text-2xl font-bold">Learn Mate</h1>
        <nav>
            <a th:href="@{/dashboard}" class="mx-2 hover:underline">Dashboard</a>
            <a th:href="@{/logout}" class="mx-2 hover:underline">Logout</a>
        </nav>
    </header>
    <div class="flex">
        <div th:replace="~{fragments/sidebar :: modern-sidebar('attendances')}"></div>
        <main class="flex-1 p-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-6 text-blue-600">Attendance Management</h2>
                
                <!-- Flash & Status Messages -->
                <div class="space-y-3 mb-6">
                    <div th:if="${success}" class="flex items-start gap-3 rounded-md border border-green-200 bg-green-50 p-4 text-green-800">
                        <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span th:text="${success}">Success message</span>
                    </div>
                    <div th:if="${error}" class="flex items-start gap-3 rounded-md border border-red-200 bg-red-50 p-4 text-red-800">
                        <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-12.728 12.728M5.636 5.636l12.728 12.728" />
                        </svg>
                        <span th:text="${error}">Error message</span>
                    </div>
                    <div th:if="${info}" class="flex items-start gap-3 rounded-md border border-blue-200 bg-blue-50 p-4 text-blue-800">
                        <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span th:text="${info}">Information message</span>
                    </div>
                </div>

                <!-- Student Attendance Statistics -->
                <div sec:authorize="hasRole('STUDENT')" class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">Your Attendance Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" th:text="${totalDays}">0</div>
                            <div class="text-sm text-gray-600">Total Days</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" th:text="${presentDays}">0</div>
                            <div class="text-sm text-gray-600">Present</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" th:text="${absentDays}">0</div>
                            <div class="text-sm text-gray-600">Absent</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-600" th:text="${#numbers.formatDecimal(attendancePercentage, 1, 1)} + '%'">0%</div>
                            <div class="text-sm text-gray-600">Attendance Rate</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" 
                                 th:style="'width: ' + ${attendancePercentage} + '%'"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Filters & Quick Search -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg space-y-4" sec:authorize="hasAnyRole('TEACHER', 'ADMIN')">
                    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        <form th:action="@{/attendances/search-by-class}" method="get" class="bg-white border border-blue-100 rounded-lg p-4 shadow-sm">
                            <label for="classId" class="block text-sm font-semibold text-blue-700 mb-2">Search by Class</label>
                            <select id="classId" name="classId" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select a class...</option>
                                <option th:each="clazz : ${classOptions}"
                                        th:value="${clazz?.id}"
                                        th:text="${clazz?.name ?: 'Unassigned'}"
                                        th:selected="${selectedClassId != null} ? ${clazz?.id} == ${selectedClassId} : false">
                                    Class Option
                                </option>
                            </select>
                            <button type="submit" class="mt-3 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition">
                                Search by Class
                            </button>
                        </form>

                        <form th:action="@{/attendances/search-by-date}" method="get" class="bg-white border border-purple-100 rounded-lg p-4 shadow-sm">
                            <label for="date" class="block text-sm font-semibold text-purple-700 mb-2">Filter by Date</label>
                            <input type="date" id="date" name="date"
                                   class="w-full border border-gray-300 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500"
                                   th:value="${selectedDate}">
                            <button type="submit" class="mt-3 w-full bg-purple-500 text-white py-2 rounded-md hover:bg-purple-600 transition">
                                Show By Date
                            </button>
                        </form>

                        <form th:action="@{/attendances/search}" method="get" class="bg-white border border-green-100 rounded-lg p-4 shadow-sm">
                            <label for="studentId" class="block text-sm font-semibold text-green-700 mb-2">Find Student</label>
                            <input type="number" id="studentId" name="studentId" placeholder="Enter student ID"
                                   class="w-full border border-gray-300 rounded-md p-2 focus:ring-green-500 focus:border-green-500"
                                   th:value="${searchStudentId}">
                            <button type="submit" class="mt-3 w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition">
                                Search Student
                            </button>
                        </form>
                    </div>
                    <p class="text-sm text-gray-500">Tip: Select a class first to get a quick overview, then narrow down by date or student.</p>
                </div>

                <div sec:authorize="hasAnyRole('TEACHER', 'ADMIN')" th:if="${#lists.isNotEmpty(classOptions)}" class="mb-6">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">Browse by Class</h3>
                    <div class="flex flex-wrap gap-2" id="classTabButtons">
                        <button type="button"
                                th:each="clazz, iterStat : ${classOptions}"
                                class="class-tab rounded-full border px-4 py-2 text-sm font-medium transition"
                                th:attr="data-target=${'class-panel-' + (clazz != null ? clazz.id : 'none')}"
                                th:classappend="${(selectedClassId != null ? (clazz != null ? clazz.id : null) == selectedClassId : iterStat.index == 0)} ? ' bg-blue-600 text-white border-blue-600 shadow' : ' bg-white text-blue-600 border-blue-200 hover:bg-blue-50'">
                            <span th:text="${clazz != null ? clazz.name : 'Shared Class'}">Class Name</span>
                        </button>
                    </div>
                </div>

                <div id="classPanels" class="space-y-6" th:if="${hasResults}">
                    <div th:each="entry, iterStat : ${groupedAttendances.entrySet()}"
                         th:with="clazz=${entry.key}, dates=${entry.value}"
                         class="class-panel bg-white border border-gray-200 rounded-xl shadow-sm"
                         th:id="${'class-panel-' + (clazz != null ? clazz.id : 'none')}"
                         th:classappend="${(selectedClassId != null ? (clazz != null ? clazz.id : null) == selectedClassId : iterStat.index == 0)} ? ' block' : ' hidden'">
                        <div class="p-6 space-y-4">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 border-b border-gray-100 pb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-blue-700" th:text="${clazz != null ? clazz.name : 'Shared Class Records'}">Class Name</h3>
                                    <p class="text-sm text-blue-500" th:if="${clazz == null}">
                                        Includes attendance from multiple classes - filter by class to narrow results.
                                    </p>
                                    <p class="text-sm text-gray-500" th:if="${selectedDate}" th:text="${'Filtered by date ' + selectedDate}">Filtered info</p>
                                </div>
                                <a sec:authorize="hasRole('TEACHER')" th:if="${clazz != null}" th:href="@{/attendances/mark/{id}(id=${clazz.id})}"
                                   class="inline-flex items-center gap-2 rounded-md border border-green-200 bg-green-50 px-4 py-2 text-sm font-semibold text-green-700 hover:bg-green-100">
                                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                    <span>Mark Attendance</span>
                                </a>
                            </div>

                            <div th:if="${#maps.isEmpty(dates)}" class="text-gray-500 text-sm">
                                No attendance records for this class yet.
                            </div>

                            <div th:unless="${#maps.isEmpty(dates)}" class="space-y-4">
                                <div th:each="dateEntry, dateStat : ${dates.entrySet()}"
                                     th:with="dateIdentifier=${dateEntry.key != null ? #temporals.format(dateEntry.key, 'yyyyMMdd') : 'unscheduled-' + dateStat.index},
                                              dateLabel=${dateEntry.key != null ? #temporals.format(dateEntry.key, 'EEEE, dd MMM yyyy') : 'No date recorded'}"
                                     class="border border-gray-100 rounded-lg overflow-hidden">
                    <button type="button"
                        class="date-toggle bg-blue-50 px-4 py-3 w-full flex items-center justify-between text-left"
                                            th:attr="data-target=${'date-panel-' + (clazz != null ? clazz.id : 'none') + '-' + dateIdentifier}, aria-expanded=${dateStat.index == 0}"
                                            th:classappend="${dateStat.index == 0} ? ' ring-1 ring-blue-200' : ''">
                                        <div>
                                            <p class="text-base font-semibold text-blue-800" th:text="${dateLabel}">Date</p>
                                            <p class="text-xs text-blue-500" th:text="${#lists.size(dateEntry.value)} + ' attendance records'">0 attendance records</p>
                                        </div>
                                        <svg class="h-5 w-5 text-blue-600 transition-transform" th:classappend="${dateStat.index == 0} ? ' rotate-180' : ''" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div class="overflow-x-auto date-panel" 
                                         th:id="${'date-panel-' + (clazz != null ? clazz.id : 'none') + '-' + dateIdentifier}"
                                         th:classappend="${dateStat.index == 0} ? ' block' : ' hidden'">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500">Student</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500">Subject</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500">Teacher</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500">Status</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500">Notes</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500" sec:authorize="hasAnyRole('TEACHER', 'ADMIN')">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-100">
                                                <tr th:each="attendance : ${dateEntry.value}" class="hover:bg-gray-50">
                                                    <td class="px-4 py-3">
                                                        <div class="font-medium text-gray-900" th:text="${attendance.student?.name}">Student Name</div>
                                                        <div class="text-xs text-gray-500" th:text="${attendance.student?.email}">student@example.com</div>
                                                    </td>
                                                    <td class="px-4 py-3 text-sm text-gray-600" th:text="${attendance.subject?.name ?: 'General'}">Subject</td>
                                                    <td class="px-4 py-3 text-sm text-gray-600" th:text="${attendance.teacher?.name ?: 'N/A'}">Teacher</td>
                                                    <td class="px-4 py-3">
                                                        <span th:if="${attendance.present}" class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-semibold text-green-800">Present</span>
                                                        <span th:unless="${attendance.present}" class="inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-xs font-semibold text-red-800">Absent</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-sm text-gray-500" th:text="${attendance.notes ?: '—'}">Notes</td>
                                                    <td class="px-4 py-3" sec:authorize="hasAnyRole('TEACHER', 'ADMIN')">
                                                        <div class="flex flex-wrap gap-2">
                                                            <a th:href="@{/attendances/edit/{id}(id=${attendance.id})}"
                                                               class="inline-flex items-center gap-1 rounded-md bg-blue-500 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-600">
                                                                Edit
                                                            </a>
                                                            <a th:href="@{/attendances/delete/{id}(id=${attendance.id})}"
                                                               class="inline-flex items-center gap-1 rounded-md bg-red-500 px-3 py-1.5 text-xs font-semibold text-white hover:bg-red-600"
                                                               onclick="return confirm('Delete this attendance record?')">
                                                                Delete
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${!hasResults}" class="rounded-lg border border-dashed border-gray-300 bg-white p-8 text-center text-gray-500">
                    <p>No attendance records to display yet. Try adjusting the filters or mark a new session.</p>
                </div>

                <div class="mt-6" sec:authorize="hasRole('TEACHER')">
                    <a th:href="@{/attendances/mark}" 
                       class="bg-green-500 text-white py-2 px-6 rounded-md hover:bg-green-600 transition inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Mark New Attendance
                    </a>
                </div>
            </div>
        </main>
    </div>
    <footer class="bg-blue-600 text-white p-4 text-center">
        &copy; 2025 Learn Mate. All rights reserved.
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buttonContainer = document.getElementById('classTabButtons');
            const panelContainer = document.getElementById('classPanels');
            if (!buttonContainer || !panelContainer) {
                return;
            }

            const buttons = Array.from(buttonContainer.querySelectorAll('.class-tab'));
            const panels = Array.from(panelContainer.querySelectorAll('.class-panel'));

            const setActive = (targetId, activeButton) => {
                buttons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600', 'shadow');
                    btn.classList.add('bg-white', 'text-blue-600', 'border-blue-200');
                });
                panels.forEach(panel => {
                    panel.classList.add('hidden');
                    panel.classList.remove('block');
                });

                if (activeButton) {
                    activeButton.classList.add('bg-blue-600', 'text-white', 'border-blue-600', 'shadow');
                    activeButton.classList.remove('bg-white', 'text-blue-600', 'border-blue-200');
                }

                const targetPanel = document.getElementById(targetId);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                    targetPanel.classList.add('block');
                }
            };

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    if (targetId) {
                        setActive(targetId, button);
                    }
                });
            });

            const dateToggleButtons = document.querySelectorAll('.date-toggle');
            dateToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    const panel = document.getElementById(targetId);
                    if (!targetId || !panel) {
                        return;
                    }

                    const isHidden = panel.classList.contains('hidden');
                    if (isHidden) {
                        panel.classList.remove('hidden');
                        panel.classList.add('block');
                        button.setAttribute('aria-expanded', 'true');
                        const icon = button.querySelector('svg');
                        if (icon) {
                            icon.classList.add('rotate-180');
                        }
                    } else {
                        panel.classList.add('hidden');
                        panel.classList.remove('block');
                        button.setAttribute('aria-expanded', 'false');
                        const icon = button.querySelector('svg');
                        if (icon) {
                            icon.classList.remove('rotate-180');
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>